<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vanilla JS Code Editor with Resizable Panes</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#00FF99',
                        secondary: '#007370',
                        dark: '#18181B',
                        darker: '#09090B',
                    }
                }
            }
        }
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/hopscotch.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.min.js"></script>

    <style>
        .CodeMirror {
            height: 100%;
            font-size: 14px;
            line-height: 1.5;
        }
        body {
            overflow: hidden;
            font-family: 'Outfit', sans-serif;
        }
        .CodeMirror-scrollbar-filler{
            opacity: 0!important;
        }
        .CodeMirror-vscrollbar::-webkit-scrollbar,
        #console-output::-webkit-scrollbar {
            width: 8px;
        }
        .CodeMirror-hscrollbar::-webkit-scrollbar{
            height: 8px;
        }
        .CodeMirror-vscrollbar::-webkit-scrollbar-track,
        .CodeMirror-hscrollbar::-webkit-scrollbar-track,
        #console-output::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        .CodeMirror-vscrollbar::-webkit-scrollbar-thumb,
        .CodeMirror-hscrollbar::-webkit-scrollbar-thumb,
        #console-output::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 4px;
        }
        .CodeMirror-vscrollbar::-webkit-scrollbar-thumb:hover,
        .CodeMirror-hscrollbar::-webkit-scrollbar-thumb:hover,
        #console-output::-webkit-scrollbar-thumb:hover {
            background: #718096; /* gray-500 */
        }
        /* Ensure panes don't shrink below their content if min-width is not 0 for flex items */
        #editor-pane, #right-pane {
            min-width: 0;
        }
    </style>
</head>
<body class="bg-darker text-white">
    <main class="flex flex-col h-screen">
        <section id="panelEditor" class="flex flex-grow p-2 h-[calc(100%-3rem)]">
            <!-- Editor Pane -->
            <div id="editor-pane" class="h-full flex flex-col rounded-xl overflow-hidden" style="flex-shrink: 0;"> <!-- Removed w-1/2, border-r -->
                <div class="flex-grow h-[calc(100%-3rem)]">
                    <textarea id="code-editor"></textarea>
                </div>
            </div>
    
            <!-- Resize Handle -->
            <div id="resize-handle" class="w-2 h-full bg-transparent cursor-col-resize flex-shrink-0"></div>
    
            <!-- Right Pane (Preview + Console) -->
            <div id="right-pane" class="h-full flex flex-col flex-grow relative rounded-xl overflow-hidden"> <!-- Removed w-1/2, added flex-grow -->
                <!-- Preview Pane -->
                <div class="h-2/3 flex flex-col">
                    <div class="flex-grow bg-white h-[calc(100%-2.5rem)]">
                        <iframe id="preview-frame" class="w-full h-full border-0" sandbox="allow-scripts allow-popups allow-forms"></iframe>
                    </div>
                </div>
    
                <!-- Console Pane -->
                <div id="console-container" class="h-1/3 bg-gray-800 border-t border-gray-700 flex flex-col">
                    <div class="bg-gray-900 p-2 text-sm font-semibold border-b border-gray-700 h-10 flex justify-between items-center">
                        <span>Console</span>
                        <button id="clear-console-btn" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">Clear</button>
                    </div>
                    <div id="console-output" class="flex-grow p-2 overflow-y-auto text-xs font-mono">
                        <!-- Console messages will appear here -->
                    </div>
                </div>
    
                <div id="preview-frame-cover-resizeable" class="absolute w-full h-full bg-black opacity-0 z-50 hidden"></div>
            </div>
        </section>
        <section id="panelControl" class="flex justify-between h-12 bg-dark">
            <div class="flex">
                <button class="w-12 h-12 flex items-center justify-center" onclick="alert('layout')">
                    <i class="fas fa-columns"></i>
                </button>
            </div>
            <div class="flex">
                <button class="w-12 h-12 flex items-center justify-center" onclick="alert('save')">
                    <i class="fas fa-save"></i>
                </button>
                <button class="w-12 h-12 flex items-center justify-center" onclick="alert('open')">
                    <i class="fas fa-folder-open"></i>
                </button>
            </div>
            <div class="flex">
                <button class="w-12 h-12 flex items-center justify-center" style="font-size: 1rem;" onclick="alert('menu')">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const editorTextArea = document.getElementById('code-editor');
            const previewFrame = document.getElementById('preview-frame');
            const consoleOutput = document.getElementById('console-output');
            const clearConsoleBtn = document.getElementById('clear-console-btn');

            const editorPane = document.getElementById('editor-pane');
            const rightPane = document.getElementById('right-pane');
            const resizeHandle = document.getElementById('resize-handle');
            const previewFrameCover = document.getElementById('preview-frame-cover-resizeable'); // Added this line
            
            // Set initial width for the editor pane (left pane)
            editorPane.style.width = '50%';

            const initialCode = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Preview</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f0f0;
            color: #333;
            padding: 20px;
            margin: 0;
        }
        h1 { color: steelblue; }
        button {
            background-color: steelblue; color: white; padding: 10px 15px;
            border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;
        }
        button:hover { background-color: darkslateblue; }
        .output { margin-top: 10px; padding: 10px; border: 1px solid #ccc; background-color: #fff; min-height: 20px; }
        .note { font-size: 0.9em; color: #555; margin-top:15px; }
    </style>
</head>
<body>
    <h1>Hello Resizable World!</h1>
    <p>Check the console below the preview for messages. Try resizing the panes!</p>
    
    <button id="testBtn">Log Message</button>
    <button id="errorBtn">Log Error</button>
    <div id="outputDiv" class="output"></div>

    <p class="note">
        <code>localStorage</code>, <code>alert</code>, etc., are restricted by the sandbox.
    </p>

    <script>
        console.log("Iframe script loaded!", { a: 1, b: "text" });
        console.warn("This is a warning from iframe.");

        const testBtn = document.getElementById('testBtn');
        const errorBtn = document.getElementById('errorBtn');
        const outputDiv = document.getElementById('outputDiv');
        let clickCount = 0;

        if (testBtn) {
            testBtn.addEventListener('click', () => {
                clickCount++;
                const complexObject = { id: clickCount, timestamp: new Date() };
                console.log("Button clicked:", clickCount, "times.", complexObject);
                if(outputDiv) outputDiv.textContent = "Logged to console. Click: " + clickCount;
            });
        }

        if (errorBtn) {
            errorBtn.addEventListener('click', () => {
                console.error("This is a test error!", new Error("Something went wrong"));
            });
        }
    <\/script>
</body>
</html>`;

            editorTextArea.value = initialCode;

            const cmEditor = CodeMirror.fromTextArea(editorTextArea, {
                mode: 'htmlmixed',
                theme: 'hopscotch',
                lineNumbers: true,
                autoCloseTags: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                tabSize: 2,
                indentUnit: 2,
            });

            const iframeConsoleBridgeScript = `
<script id="iframe-console-bridge">
(function() {
    'use strict';
    const originalConsole = {};
    const methods = ['log', 'error', 'warn', 'info', 'debug', 'clear'];
    methods.forEach(method => {
        originalConsole[method] = console[method] ? console[method].bind(console) : () => {};
    });

    function formatArgsForPostMessage(args) {
        return Array.from(args).map(arg => {
            if (arg instanceof Error) return \`Error: \${arg.message}\${arg.stack ? \`\\nStack: \${arg.stack}\` : ''}\`;
            if (arg instanceof HTMLElement) {
                let attrs = Array.from(arg.attributes).map(attr => \`\${attr.name}="\${attr.value}"\`).join(' ');
                return \`<\${arg.tagName.toLowerCase()}\${attrs ? ' ' + attrs : ''}>...\`;
            }
            if (typeof arg === 'function') return '[Function]';
            if (typeof arg === 'symbol') return arg.toString();
            if (typeof arg === 'object' && arg !== null) {
                try {
                    const cache = new Set();
                    return JSON.stringify(arg, (key, value) => {
                        if (typeof value === 'object' && value !== null) {
                            if (cache.has(value)) return '[Circular Reference]';
                            cache.add(value);
                        }
                        if (value instanceof HTMLElement) return \`<\${value.tagName.toLowerCase()}> (embedded HTML Element)\`;
                        return value;
                    }, 2);
                } catch (e) { return '[Unserializable Object]'; }
            }
            return String(arg);
        });
    }

    methods.forEach(methodName => {
        if (methodName === 'clear') {
            console.clear = function() {
                if (originalConsole.clear) originalConsole.clear();
                try { window.parent.postMessage({ type: 'iframe-console', method: 'clear' }, '*'); }
                catch(e) { if(originalConsole.error) originalConsole.error('Console bridge error (clear):', e); }
            };
        } else {
            console[methodName] = function(...args) {
                if (originalConsole[methodName]) originalConsole[methodName](...args);
                try { window.parent.postMessage({ type: 'iframe-console', method: methodName, args: formatArgsForPostMessage(args) }, '*'); }
                catch(e) { if(originalConsole.error) originalConsole.error('Console bridge error ('+methodName+'):', e); }
            };
        }
    });

    window.addEventListener('error', function(event) {
        const errorArgs = [\`Unhandled error: \${event.message}\`, \`at \${event.filename || 'unknown'}:\${event.lineno || 0}:\${event.colno || 0}\`];
        if (originalConsole.error) originalConsole.error(...errorArgs);
        try { window.parent.postMessage({ type: 'iframe-console', method: 'error', args: errorArgs }, '*'); }
        catch(e) { if(originalConsole.error) originalConsole.error('Console bridge error (onerror):', e); }
    });

    window.addEventListener('unhandledrejection', function(event) {
        const reason = event.reason instanceof Error ? \`\${event.reason.message}\\n\${event.reason.stack}\` : String(event.reason);
        const rejectionArgs = ['Unhandled promise rejection:', reason];
        if (originalConsole.warn) originalConsole.warn(...rejectionArgs);
        try { window.parent.postMessage({ type: 'iframe-console', method: 'warn', args: rejectionArgs }, '*'); }
        catch(e) { if(originalConsole.error) originalConsole.error('Console bridge error (unhandledrejection):', e); }
    });
    
    setTimeout(() => {
        try { 
            window.parent.postMessage({ type: 'iframe-ready' }, '*');
            if (originalConsole.log) originalConsole.log("Console bridge initialized in iframe.");
        } catch(e) { if(originalConsole.error) originalConsole.error('Console bridge error (ready):', e); }
    }, 0);
})();
<\/script>
`;

            function updatePreview() {
                const userCode = cmEditor.getValue();
                const fullCode = iframeConsoleBridgeScript + userCode;
                
                if (previewFrame) {
                    previewFrame.src = 'data:text/html;charset=utf-8,' + encodeURIComponent(fullCode);
                }
            }

            let debounceTimeout;
            function debouncedUpdatePreview() {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(updatePreview, 300);
            }

            cmEditor.on('change', debouncedUpdatePreview);

            window.addEventListener('message', (event) => {
                if (event.source !== previewFrame.contentWindow || !event.data) return;
                const data = event.data;

                if (data.type === 'iframe-console') {
                    const messageLine = document.createElement('div');
                    messageLine.classList.add('p-1', 'border-b', 'border-gray-700', 'flex', 'items-start');
                    let methodColor = 'text-gray-300', methodIcon = '➡️';
                    switch (data.method) {
                        case 'error': methodColor = 'text-red-400'; methodIcon = '❌'; break;
                        case 'warn': methodColor = 'text-yellow-400'; methodIcon = '⚠️'; break;
                        case 'info': methodColor = 'text-blue-400'; methodIcon = 'ℹ️'; break;
                        case 'debug': methodColor = 'text-purple-400'; methodIcon = '🐞'; break;
                        case 'clear':
                            consoleOutput.innerHTML = '';
                            const clearedMsg = document.createElement('div');
                            clearedMsg.className = 'p-1 text-gray-500 italic';
                            clearedMsg.textContent = 'Console cleared by iframe.';
                            consoleOutput.appendChild(clearedMsg);
                            consoleOutput.scrollTop = consoleOutput.scrollHeight;
                            return;
                    }
                    messageLine.classList.add(methodColor);
                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'mr-2 select-none'; iconSpan.textContent = methodIcon;
                    messageLine.appendChild(iconSpan);
                    const contentWrapper = document.createElement('div');
                    contentWrapper.className = 'flex-grow';
                    if (data.args && data.args.length > 0) {
                        const messageContent = document.createElement('pre');
                        messageContent.className = 'whitespace-pre-wrap break-words';
                        messageContent.textContent = data.args.join(' ');
                        contentWrapper.appendChild(messageContent);
                    } else {
                        const emptyMsg = document.createElement('span');
                        emptyMsg.textContent = (data.method === 'log') ? '(empty log)' : `(${data.method} with no arguments)`;
                        emptyMsg.className = 'italic opacity-70';
                        contentWrapper.appendChild(emptyMsg);
                    }
                    messageLine.appendChild(contentWrapper);
                    consoleOutput.appendChild(messageLine);
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                } else if (data.type === 'iframe-ready') {
                    const readyMsg = document.createElement('div');
                    readyMsg.className = 'p-1 text-green-400 italic';
                    readyMsg.textContent = 'iframe console connected.';
                    consoleOutput.appendChild(readyMsg);
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                }
            });

            clearConsoleBtn.addEventListener('click', () => {
                consoleOutput.innerHTML = '';
                const clearedMsg = document.createElement('div');
                clearedMsg.className = 'p-1 text-gray-500 italic';
                clearedMsg.textContent = 'Console cleared by editor.';
                consoleOutput.appendChild(clearedMsg);
            });

            // Pane resizing logic
            let isResizing = false;
            let initialMouseX = 0;
            let initialEditorWidth = 0;

            resizeHandle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isResizing = true;
                initialMouseX = e.clientX;
                initialEditorWidth = editorPane.offsetWidth;

                if (previewFrameCover) { // Added this block
                    previewFrameCover.classList.remove('hidden');
                }

                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';

                document.addEventListener('mousemove', handlePaneMouseMove);
                document.addEventListener('mouseup', handlePaneMouseUp);
            });

            function handlePaneMouseMove(e) {
                if (!isResizing) return;

                const deltaX = e.clientX - initialMouseX;
                let newEditorWidth = initialEditorWidth + deltaX;

                const totalWidth = editorPane.parentElement.offsetWidth;
                const handleWidth = resizeHandle.offsetWidth;
                // Min width for editor pane, e.g., 15% of total, or a fixed pixel value
                const minPixelWidthEditor = Math.max(100, totalWidth * 0.15); 
                // Min width for right pane (preview + console)
                const minPixelWidthRight = Math.max(100, totalWidth * 0.15); 

                // Calculate max width for editor pane based on min width for right pane
                const maxPixelWidthEditor = totalWidth - minPixelWidthRight - handleWidth;
                
                newEditorWidth = Math.max(minPixelWidthEditor, Math.min(newEditorWidth, maxPixelWidthEditor));
                
                editorPane.style.width = `${newEditorWidth}px`;
                // Right pane width will adjust due to flex-grow
            }

            function handlePaneMouseUp() {
                if (!isResizing) return;
                isResizing = false;

                if (previewFrameCover) { // Added this block
                    previewFrameCover.classList.add('hidden');
                }

                document.body.style.cursor = '';
                document.body.style.userSelect = '';

                document.removeEventListener('mousemove', handlePaneMouseMove);
                document.removeEventListener('mouseup', handlePaneMouseUp);

                // Refresh CodeMirror editor after resizing is complete
                if (cmEditor) {
                    cmEditor.refresh();
                }
            }

            updatePreview(); // Initial load
        });
    </script>

</body>
</html>